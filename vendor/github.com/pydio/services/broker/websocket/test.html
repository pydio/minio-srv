<html>
<head>
    <title>WS Tests</title>
</head>

<style>
    #chat {
        text-align: left;
        background: #f1f1f1;
        height: calc(100% - 130px);
        padding: 20px;
        overflow: auto;
    }
</style>

<body style="position: absolute;top: 0; bottom: 0; left: 0; right: 0;">
<div style="text-align: center; height: 100%;">
    <h3>Tree Events</h3>
    <pre id="chat"></pre>
    <input placeholder="say something" id="text" type="text">
</div>

<script>
    var url = "ws://" + window.location.host + "/ws";
    var ws = new WebSocket(url);
    var name = "Guest" + Math.floor(Math.random() * 1000);

    var chat = document.getElementById("chat");
    var text = document.getElementById("text");

    var now = function () {
        var iso = new Date().toISOString();
        return iso.split("T")[1].split(".")[0];
    };

    ws.onmessage = function (msg) {
        var object = JSON.parse(msg.data);
        chat.innerText +=  now() + "\n " + JSON.stringify(object, undefined, 4)+ "\n\n";
    };

    text.onkeydown = function (e) {
        if (e.keyCode === 13 && text.value !== "") {
            ws.send("<" + name + "> " + text.value);
            text.value = "";
        }
    };

    var jwt = window.location.hash.replace('#', '');

    ws.onopen = function(){
        console.log("connection open, sending subscribe message");
        ws.send(JSON.stringify({
            "@type":"subscribe",
            "jwt"  : jwt
        }));
    };
    ws.onerror = function(){
        console.log("error")
    };


</script>
</body>
</html>